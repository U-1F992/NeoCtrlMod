# 調査メモ

## 本体の選定

3DSシリーズにはいくつか種別があります。3DSと3DS LLではTPはほぼ共通[^1]です。New 3DS以降はTP番号がシルク印刷されていませんが、以下で紹介するほぼすべての要素に対応するTPおよびビア等が明らかになっています[^2]。

| 種別            | 特徴                                                                                                                    |
| --------------- | ----------------------------------------------------------------------------------------------------------------------- |
| 3DS（o3DS）     | 入手しやすい。キャプチャ基板の取り付けが比較的容易[^3]だが、本体内にスペースの余裕がない。                              |
| 3DS LL（XL）    | キャプチャ基板の取り付けが比較的容易[^4]で、本体内に基板を収める余裕がある。                                            |
| New 3DSシリーズ | 本体性能が向上し、New専用ソフトもある。<br>キャプチャ基板の取り付けが高難易度、現実的ではない[^5]。操作用のTP等も同様。 |
| 2DSシリーズ     | （知見が少ないため除外）                                                                                                |

自動操作に対応できないゲームソフトが出てきますが、他改造との共存のしやすさと工作精度の懸念から、3DS LLをベースに開発を進めます。

[^1]: http://problemkaputt.de/gbatek-3ds-testpoints.htm
[^2]: http://imaginglabo.web.fc2.com/new3DSLL-barabara.html
[^3]: https://optimize.ath.cx/N-SPA3/index.htm
[^4]: https://optimize.ath.cx/LL-SPA3/index.htm
[^5]: https://optimize.ath.cx/NEW3DS/index.htm

## ボタン

| Function  | TP  |
| --------- | --- |
| Y         | 88  |
| B         | 92  |
| A         | 89  |
| X         | 86  |
| L         | 83  |
| R         | 82  |
| Select    | 81  |
| Start     | 80  |
| Home      | 55  |
| 電源      | 52  |
| Wi-Fi切替 | 58  |
| ↑         | 85  |
| →         | 90  |
| ↓         | 91  |
| ←         | 87  |

押下されることでランド同士が導通する一般的な構造です。15個のTPが露出しており、それぞれアクティブローのデジタル入力です。解放時は1.8V出力ではなくハイインピーダンス状態にすることで、レベル変換が不要になります。

## スライドパッド

| Function | TP  |
| -------- | --- |
| X軸      | 69  |
| Y軸      | 68  |

2基のポテンショメータで構成されます。フレキシブルケーブルの4線は、GND、X軸出力、1.8V、Y軸出力に対応します。X軸は右から左、Y軸は下から上に0～1.8Vのアナログ入力です。

![](slidepad.drawio.svg)

スライドパッドが取り付けられておりニュートラルポジションの状態では、各TPは約0.9Vの状態です。電圧を変化させるには、±250μAのシンク／ソースを切り替えられる、電流出力のD/Aコンバータが必要です。ニュートラルより右／下に動かすときはシンク電流で電圧を下げ、左／上に動かすときはソース電流で電圧を上げます。

## タッチスクリーン

| Function | TP  |
| -------- | --- |
| X+       | 216 |
| X-       | 215 |
| Y+       | 213 |
| Y-       | 214 |

タッチスクリーンの原理として、X軸とY軸にそれぞれ1基のポテンショメータが搭載されており、押下されることでワイパー同士が接続される状態をイメージしてください。

![](touchscreen_as_potentiometers.drawio.svg)

3DSでは、4つのピンの機能を以下のように操作することで、押下の検出と各座標の取得を行います（指定のないピンはハイインピーダンス状態と考えられます）。

- Y+をプルアップ回路付きデジタル入力、X-をLOWとして押下を検知 → 以下の割り込み処理を発火
- X+をHIGH、X-をLOW、Y+をアナログ入力とすることで、X座標を取得
- Y+をHIGH、Y-をLOW、X+をアナログ入力とすることで、Y座標を取得

3xtDSではピンを監視し時間を計測してX+とY+に直接アナログ出力をしていましたが、マイクロ秒精度の制御が必要であるほか、タッチ入力がブロッキング処理になりタッチしながらほかの操作を受け付けられない、境界値付近の入力は困難という課題がありました。

このプロジェクトでは、X+〜X-間とY+〜Y-間にデジタルポテンショメータを接続し、ワイパー同士をリレーを挟んで接続します。リレーがオンになることでY+はLOWになり、両方向で分圧回路が成立します。解放時はリレーをオフにするとともにデジタルポテンショメータもシャットダウンすることで、本体のタッチ入力機能を維持できます。

![](digital_potentiometers.drawio.svg)

3DS LLにおいて実際のタッチスクリーンの全抵抗値は、X軸方向が約460Ω、Y軸方向が約360Ωです。プルアップ抵抗値は不明ですが、全抵抗値が可能な限り低いデジタルポテンショメータを使用する必要があると考えられます。実験の結果、X軸に全抵抗値2kΩ、Y軸に1kΩのポテンショメータとするのは問題ないようです。

執筆時点で、市販品には1kΩ未満の高分解能なデジタルポテンショメータはありません。Y軸の240pxは8bitで対応できますが、X軸の320pxを指定するために、3基のポテンショメータを使用することで対処しています[^6]。

[^6]: https://www.analog.com/media/en/technical-documentation/application-notes/AN-582.pdf

## 拡張スライドパッド／赤外線

TP255に露出していることはわかっていますが、詳細はわかりません。

Controller Modには拡張スライドパッドのエミュレーション機能がありますが、もとがPSoCなうえアセンブリ言語も用いているので移植が困難です。PIOも別コアも空いているので、気概さえあれば実装できます。

## 電源

+5.0Vからマイコンに電力を供給します。

| 電圧 | TP  |
| ---- | --- |
| +5.0 | 32  |
| GND  | 1   |
